<!DOCTYPE html>
<html class="dark" lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TiketGo — Keranjang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    :root{--bg:#0f0f10;--muted:#9ca3af;--accent:#ea2a33}
    .material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}
    body{font-family:"Plus Jakarta Sans",sans-serif;background:var(--bg);color:#fff;min-height:100dvh}
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <header class="sticky top-0 z-30 bg-[rgba(10,10,10,0.9)] px-4 py-3 border-b border-white/6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="Beranda.html" class="p-2"><span class="material-symbols-outlined">arrow_back</span></a>
      <h1 class="text-lg font-semibold">Keranjang</h1>
    </div>
    <a href="tiket.html" class="p-2"><span class="material-symbols-outlined">confirmation_number</span></a>
  </header>

  <main class="flex-1 overflow-y-auto px-4 py-4 pb-36">
    <div id="cartList" class="space-y-3"></div>

    <div id="emptyCart" class="text-center text-[--muted] mt-12 hidden">
      <p class="mb-3">Keranjang kosong</p>
      <a href="Beranda.html" class="inline-block bg-[--accent] px-4 py-2 rounded-lg">Cari Acara</a>
    </div>
  </main>

  <!-- Checkout bar fixed above navbar -->
  <div id="checkoutBar" class="fixed left-1/2 -translate-x-1/2 bottom-24 w-[min(96%,1100px)] bg-[rgba(10,10,10,0.95)] border border-white/6 rounded-lg px-4 py-3 hidden z-40">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-[--muted]">Total</div>
        <div class="text-lg font-bold" id="totalPrice">Rp 0</div>
      </div>
      <div>
        <button id="payBtn" class="bg-[--accent] px-4 py-2 rounded-lg font-semibold">Bayar Sekarang</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navbar -->
  <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 w-[min(98%,1200px)] bg-[rgba(10,10,10,0.95)] border border-white/6 rounded-2xl flex justify-between px-4 py-2 items-center">
    <a href="Beranda.html" class="flex flex-col items-center text-white/80 hover:text-[--accent]"><span class="material-symbols-outlined">home</span><span class="text-xs">Beranda</span></a>
    <a href="Pencarian.html" class="flex flex-col items-center text-white/80 hover:text-[--accent]"><span class="material-symbols-outlined">search</span><span class="text-xs">Cari</span></a>
    <a href="tiket.html" class="flex flex-col items-center text-white/80 hover:text-[--accent]"><span class="material-symbols-outlined">confirmation_number</span><span class="text-xs">Tiket</span></a>
    <a href="keranjang.html" class="flex flex-col items-center text-[--accent]"><span class="material-symbols-outlined">shopping_cart</span><span class="text-xs">Keranjang</span></a>
    <a href="#" class="flex flex-col items-center text-white/80 hover:text-[--accent]"><span class="material-symbols-outlined">person</span><span class="text-xs">Akun</span></a>
  </nav>

  <script>
    const CART_KEY = 'tiketgo_cart';
    const PURCHASE_KEY = 'tiketgo_purchased';
    function getCart(){ try{return JSON.parse(localStorage.getItem(CART_KEY)||'[]')}catch(e){return []} }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCart(); updateNavBadge(); }
    function numberWithDots(x){ return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    const cartList = document.getElementById('cartList');
    const emptyCart = document.getElementById('emptyCart');
    const checkoutBar = document.getElementById('checkoutBar');
    const totalPriceEl = document.getElementById('totalPrice');
    const payBtn = document.getElementById('payBtn');

    function renderCart(){
      const c = getCart();
      cartList.innerHTML = '';
      if(!c.length){ emptyCart.classList.remove('hidden'); checkoutBar.classList.add('hidden'); updateNavBadge(); return; }
      emptyCart.classList.add('hidden'); checkoutBar.classList.remove('hidden');

      let total = 0;
      c.forEach((it, idx)=>{
        total += it.price * it.qty;
        const row = document.createElement('div');
        row.className = 'flex items-start gap-3 bg-[rgba(255,255,255,0.02)] rounded-lg p-3';
        row.innerHTML = `
          <img src="${it.img}" alt="${escapeHtml(it.title)}" class="h-20 w-28 rounded object-cover"/>
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(it.title)}</div>
            <div class="text-xs text-[--muted]">Rp ${numberWithDots(it.price)} • Qty: <span id="qty-${idx}">${it.qty}</span></div>
            <div class="mt-3 flex gap-2">
              <button data-idx="${idx}" class="decBtn px-3 py-1 rounded bg-white/6">-</button>
              <button data-idx="${idx}" class="incBtn px-3 py-1 rounded bg-white/6">+</button>
              <button data-idx="${idx}" class="rmBtn px-3 py-1 rounded bg-red-700/80">Hapus</button>
            </div>
          </div>
          <div class="text-right font-bold text-[--accent]">Rp ${numberWithDots(it.price * it.qty)}</div>
        `;
        cartList.appendChild(row);
      });
      totalPriceEl.textContent = 'Rp ' + numberWithDots(total);
      updateNavBadge();
    }

    // update badge in navbar (by writing to localStorage triggers storage event on other tabs)
    function updateNavBadge(){
      const badgeEls = document.querySelectorAll('#cartBadge, #cartBadgeNav, #cartBadgeTop');
      const c = getCart();
      const total = c.reduce((s,i)=>s+(i.qty||0),0);
      badgeEls.forEach(b=>{
        if(!b) return;
        if(total>0){ b.textContent = total; b.classList.remove('hidden'); } else b.classList.add('hidden');
      });
    }

    // delegate clicks
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.incBtn')){
        const i = e.target.closest('.incBtn').dataset.idx;
        const c = getCart(); c[i].qty++; saveCart(c);
      }
      if(e.target.closest('.decBtn')){
        const i = e.target.closest('.decBtn').dataset.idx;
        const c = getCart(); c[i].qty = Math.max(1, c[i].qty-1); saveCart(c);
      }
      if(e.target.closest('.rmBtn')){
        const i = e.target.closest('.rmBtn').dataset.idx;
        const c = getCart(); c.splice(i,1); saveCart(c);
      }
    });

    // pay: simulate payment -> move cart to purchased, clear cart, redirect to tiket.html
    payBtn.addEventListener('click', ()=>{
      const cart = getCart();
      if(!cart.length) return alert('Keranjang kosong');
      const purchased = (JSON.parse(localStorage.getItem(PURCHASE_KEY)||'[]'));
      // add ticketCode for each
      const timestamp = Date.now();
      cart.forEach((it, idx)=>{
        purchased.unshift({...it, purchasedAt: new Date().toISOString(), ticketCode: 'TKT' + (timestamp + idx)});
      });
      localStorage.setItem(PURCHASE_KEY, JSON.stringify(purchased));
      localStorage.removeItem(CART_KEY);
      // update UI & badge
      renderCart();
      updateNavBadge();
      alert('Pembayaran simulasi berhasil! Tiket ditambahkan ke halaman Tiket.');
      location.href = 'tiket.html';
    });

    // init
    renderCart();
    window.addEventListener('storage', (e)=>{ if(e.key === CART_KEY || e.key === PURCHASE_KEY) renderCart(); });
  </script>
</body>
</html>
